<!DOCTYPE html>
<html lang="zh-Hans">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1,user-scalable=no"/>
<title>ä½œä¸šæ”¶é›†è®°å½•è¡¨ Â· å¤šä½œä¸šç‰ˆï¼ˆå«å­¦å·+åå•ç®¡ç†ï¼‰</title>
<style>
:root{
  --bg:#f7f8fa;--card:#fff;--border:#dfe3ea;--text:#1a1a1a;--dim:#6b7280;
  --accent:#2b6fff;--accent-bg:#ecf2ff;--good:#18794e;--good-bg:#eafff4;
  --warn:#b96a00;--warn-bg:#fff9e8;--bad:#d7263d;--bad-bg:#fff5f5;
  --radius-lg:16px;--radius-md:10px;--radius-sm:8px;
  --font:-apple-system,BlinkMacSystemFont,"SF Pro Text","Helvetica Neue",Arial,sans-serif;
}
*{box-sizing:border-box}
body{margin:0;background:var(--bg);font-family:var(--font);color:var(--text);padding:14px}
header{display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;gap:8px;flex-wrap:wrap}
h1{font-size:1.05rem;margin:0;font-weight:700}
.small{font-size:.78rem;color:var(--dim)}
.card{background:var(--card);border:1px solid var(--border);border-radius:16px;box-shadow:0 8px 24px rgba(0,0,0,.06);padding:14px;margin-bottom:14px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.field{flex:1;min-width:150px}
label{display:block;font-size:.78rem;color:var(--dim);margin-bottom:4px}
input[type="text"],input[type="number"],input[type="date"],select{
  width:100%;padding:10px 12px;border:1px solid var(--border);border-radius:10px;font-size:.95rem;background:#fff;outline:none
}
input:focus,select:focus{border-color:var(--accent);box-shadow:0 0 0 3px var(--accent-bg)}
button{border:1px solid var(--border);background:#fff;border-radius:12px;padding:10px 12px;font-weight:600}
button.primary{background:var(--accent);color:#fff;border-color:var(--accent)}
button.ghost{background:#f5f7ff}
button.danger{background:#fff5f5;border-color:#f3c1c1;color:#b42318}
.tabs{display:flex;gap:8px;overflow:auto;padding-bottom:6px}
.tab{padding:8px 10px;border:1px solid var(--border);border-radius:10px;background:#fff;white-space:nowrap}
.tab.active{background:var(--accent);border-color:var(--accent);color:#fff;font-weight:700}
.hr{height:1px;background:var(--border);margin:10px -2px}
.table{width:100%;border-collapse:collapse}
.table th{font-size:.72rem;color:var(--dim);text-align:left;padding:8px;border-bottom:1px solid var(--border);text-transform:uppercase;letter-spacing:.03em}
.table td{padding:10px 8px;border-bottom:1px solid var(--border);vertical-align:top}
.name{font-weight:700}
.stbtn{display:inline-block;min-width:88px;text-align:center;border-radius:10px;padding:8px 10px;border:1px solid var(--border);font-weight:700}
.st-miss{background:#fff5f5;color:var(--bad);border-color:#f3c1c1}
.st-fix{background:#fff9e8;color:var(--warn);border-color:#f5d69d}
.st-done{background:#eafff4;color:var(--good);border-color:#9fe3bf}
.note{width:100%;min-width:160px}
footer{color:var(--dim);font-size:.78rem;text-align:center;margin-top:8px}
.pills{display:flex;flex-wrap:wrap;gap:8px}
.pill{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:.85rem}
.pill.miss{background:#fff5f5;color:var(--bad)}
.pill.fix{background:#fff9e8;color:var(--warn)}
.pill.done{background:#eafff4;color:var(--good)}
.util{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
.hide{display:none}

/* å­¦ç”Ÿæ€»è§ˆåˆ—è¡¨ */
.student-list{display:flex;flex-direction:column;gap:10px}
.student-row{display:flex;gap:10px;align-items:flex-start;flex-wrap:wrap;border:1px solid var(--border);border-radius:12px;padding:10px;background:#fff}
.student-row .stu-name{min-width:140px;font-weight:800}
.tags{display:flex;gap:8px;flex-wrap:wrap}
.tag{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:.85rem}
.tag.miss{background:#fff5f5;color:var(--bad)}
.tag.fix{background:#fff9e8;color:var(--warn)}
.tag.done{background:#eafff4;color:var(--good)}
.statline{font-size:.78rem;color:var(--dim)}

/* æ‰¹é‡æ›´æ–°å·¥å…·æ¡ */
.bulkbar{display:flex;gap:8px;flex-wrap:wrap;align-items:center;margin:8px 0}
.bulkbar .sep{width:1px;height:20px;background:var(--border)}
.checkbox{transform:scale(1.2)}

/* ä½œä¸šé—®é¢˜æ€»è§ˆ */
.issue-wrap{display:flex;flex-direction:column;gap:12px}
.issue-card{border:1px solid var(--border);background:#fff;border-radius:12px;padding:12px}
.issue-title{font-weight:800;margin-bottom:8px}
.issue-row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
.issue-row .label{font-size:.85rem;color:var(--dim)}
.chips{display:flex;gap:8px;flex-wrap:wrap}
.chip{border:1px solid var(--border);border-radius:999px;padding:6px 10px;font-size:.85rem}
.chip.miss{background:#fff5f5;color:var(--bad)}
.chip.fix{background:#fff9e8;color:var(--warn)}
</style>
</head>
<body>
<header>
  <h1>åæ–‡ä½œä¸šæ”¶é›†è®°å½•è¡¨ Â· å¤šä½œä¸šç‰ˆï¼ˆå«å­¦å·+åå•ç®¡ç†ï¼‰</h1>
  <div class="small" id="saveInfo">æœªä¿å­˜</div>
</header>

<!-- é¡¶éƒ¨ï¼šæ¨¡å¼ -->
<section class="card">
  <div class="row">
    <div class="field" style="min-width:120px;flex:0 0 180px">
      <label>è§†å›¾</label>
      <select id="viewMode">
        <option value="assignment">æŒ‰ä½œä¸šç®¡ç†ï¼ˆé»˜è®¤ï¼‰</option>
        <option value="student">æŒ‰å­¦ç”ŸæŸ¥çœ‹ï¼ˆå…¨ç­ï¼‰</option>
      </select>
    </div>
  </div>
</section>

<!-- âœ… åå•ç®¡ç†ï¼ˆæ–°å¢ï¼‰ -->
<section class="card" id="rosterCard">
  <div class="row" style="align-items:flex-end">
    <div class="field" style="flex:0 0 140px;min-width:120px">
      <label>å­¦å·</label>
      <input type="number" id="newStuId" placeholder="ä¾‹å¦‚ 36" min="1"/>
    </div>
    <div class="field" style="flex:1;min-width:180px">
      <label>å§“å</label>
      <input type="text" id="newStuName" placeholder="ä¾‹å¦‚ï¼šå¼ ä¸‰"/>
    </div>
    <div class="field" style="flex:0 0 120px">
      <button class="primary" id="addStudentBtn">æ·»åŠ å­¦ç”Ÿ</button>
    </div>
  </div>

  <div class="hr"></div>

  <div class="row" style="align-items:flex-end">
    <div class="field" style="flex:1;min-width:220px">
      <label>åˆ é™¤å­¦ç”Ÿ</label>
      <select id="deleteStudentSelect"></select>
    </div>
    <div class="field" style="flex:0 0 140px">
      <button class="danger" id="deleteStudentBtn">åˆ é™¤é€‰ä¸­</button>
    </div>
  </div>

  <div class="small" style="margin-top:8px">
    è¯´æ˜ï¼šæ·»åŠ /åˆ é™¤ä¼šè‡ªåŠ¨åŒæ­¥åˆ°æ‰€æœ‰ä½œä¸šè®°å½•é‡Œï¼›åˆ é™¤åè¯¥å­¦ç”Ÿåœ¨æ‰€æœ‰ä½œä¸šçš„æ•°æ®éƒ½ä¼šç§»é™¤ï¼ˆä¸å¯æ¢å¤ï¼‰ã€‚
  </div>
</section>

<!-- ä½œä¸šåŒºï¼šæ–°å¢ / åˆ‡æ¢ / åˆ é™¤ -->
<section class="card" id="assignmentBar">
  <div class="row">
    <div class="field" style="flex:2">
      <label>æ–°å¢ä½œä¸šåç§°</label>
      <input type="text" id="newAssignmentName" placeholder="ä¾‹å¦‚ï¼šç¬¬9è¯¾å¬å†™ / ä½œä¸šæœ¬P12-15"/>
    </div>
    <div class="field" style="flex:0 0 130px">
      <label>æ—¥æœŸ</label>
      <input type="date" id="newAssignmentDate"/>
    </div>
    <div class="field" style="flex:0 0 120px;align-self:flex-end">
      <button class="primary" id="addAssignmentBtn">æ–°å¢ä½œä¸š</button>
    </div>
  </div>
  <div class="hr"></div>
  <div class="small">ç‚¹é€‰ä¸‹æ–¹æ ‡ç­¾åˆ‡æ¢ä½œä¸šï¼›å…¨éƒ¨å­¦ç”Ÿéƒ½ã€Œâœ… å®Œæˆã€æ—¶ï¼Œå¯åˆ é™¤è¯¥ä½œä¸šã€‚</div>
  <div class="tabs" id="assignmentTabs"></div>
  <div class="util">
    <button id="deleteAssignmentBtn" class="ghost">åˆ é™¤å½“å‰ä½œä¸š</button>
    <span class="small" id="allDoneHint"></span>
  </div>
</section>

<!-- æŒ‰ä½œä¸šç®¡ç† -->
<section class="card" id="byAssignment">
  <div class="row" style="align-items:center;justify-content:space-between">
    <div class="small" id="currentAssignmentTitle">å½“å‰ï¼šâ€”</div>
    <div class="pills">
      <span class="pill miss">âŒ æœªäº¤</span>
      <span class="pill fix">ğŸ“ è®¢æ­£</span>
      <span class="pill done">âœ… å®Œæˆ</span>
    </div>
  </div>

  <!-- æ‰¹é‡æ›´æ–°å·¥å…·æ¡ -->
  <div class="bulkbar">
    <strong class="small">æ‰¹é‡æ›´æ–°ï¼š</strong>
    <button id="bulkAllMissing">å…¨ç­è®¾ä¸º âŒæœªäº¤</button>
    <button id="bulkAllFix">å…¨ç­è®¾ä¸º ğŸ“è®¢æ­£</button>
    <button id="bulkAllDone">å…¨ç­è®¾ä¸º âœ…å®Œæˆ</button>
    <span class="sep"></span>
    <span class="small">å¯¹å·²å‹¾é€‰å­¦ç”Ÿï¼š</span>
    <select id="bulkSelectStatus" style="flex:0 0 140px">
      <option value="0">è®¾ä¸º âŒæœªäº¤</option>
      <option value="1">è®¾ä¸º ğŸ“è®¢æ­£</option>
      <option value="2">è®¾ä¸º âœ…å®Œæˆ</option>
    </select>
    <button id="bulkApplySelected" class="ghost">åº”ç”¨</button>
    <button id="bulkClearSelection" class="ghost">æ¸…é™¤å‹¾é€‰</button>
  </div>

  <div style="overflow:auto">
    <table class="table">
      <thead>
        <tr>
          <th style="width:40px"><input type="checkbox" id="selectAll" class="checkbox" title="å…¨é€‰/å…¨ä¸é€‰"/></th>
          <th>å­¦å·Â·å§“å</th>
          <th>çŠ¶æ€</th>
          <th>å¤‡æ³¨</th>
        </tr>
      </thead>
      <tbody id="tbodyAssignment"></tbody>
    </table>
  </div>
</section>

<!-- ä½œä¸šæœ‰é—®é¢˜æ€»è§ˆï¼ˆç½®äºå­¦ç”Ÿåå•ä¸Šæ–¹ï¼‰ -->
<section class="card hide" id="issueSection">
  <div class="row" style="align-items:center;justify-content:space-between">
    <div class="small"><strong>ä½œä¸šæœ‰é—®é¢˜æ€»è§ˆï¼š</strong>æŒ‰ä½œä¸šæ±‡æ€»éœ€è¦è·Ÿè¿›çš„å­¦ç”Ÿï¼ˆå¯ç‚¹åæ¡åˆ‡æ¢çŠ¶æ€ï¼‰ã€‚</div>
  </div>
  <div id="issueOverview" class="issue-wrap"></div>
</section>

<!-- æŒ‰å­¦ç”ŸæŸ¥çœ‹ï¼ˆå…¨ç­ï¼‰ -->
<section class="card hide" id="byStudent">
  <div class="row" style="align-items:center;justify-content:space-between">
    <div class="small">å…¨ç­å­¦ç”Ÿåˆ—è¡¨ï¼šæ¯ä½å­¦ç”Ÿæ—è¾¹æ˜¾ç¤ºã€æœªäº¤ / è®¢æ­£ã€‘çš„ä½œä¸šï¼ˆâœ…å®Œæˆçš„ä¸æ˜¾ç¤ºï¼‰ã€‚ç‚¹æ ‡ç­¾å¯åˆ‡æ¢çŠ¶æ€ã€‚</div>
    <div class="pills">
      <span class="pill miss">âŒ æœªäº¤</span>
      <span class="pill fix">ğŸ“ è®¢æ­£</span>
    </div>
  </div>
  <div id="studentOverview" class="student-list"></div>
</section>

<footer>æ•°æ®ä»…ä¿å­˜åœ¨æœ¬æœºæµè§ˆå™¨ Â· é€‚é… iPhone Safari Â· å¯ç¦»çº¿ä½¿ç”¨</footer>

<script>
/* ===== é»˜è®¤å­¦ç”Ÿåå•ï¼ˆé¦–æ¬¡ä½¿ç”¨æ—¶å¡«å…¥ï¼›ä¹‹åå¯è‡ªè¡Œå¢åˆ ï¼‰ ===== */
const DEFAULT_STUDENTS = [
{ id:1, name:"ä¹‰å±±" },{ id:2, name:"é²å­å½¦" },{ id:3, name:"æ¶‚èŠŠç†™" },
{ id:4, name:"é™ˆæ¢“æ‚¦" },{ id:5, name:"è”¡éŸ¶çœŸ" },{ id:6, name:"è”¡æ”¿å®" },
{ id:7, name:"è”¡æ”¿åŸ" },{ id:8, name:"èŒƒé–ç‘„" },{ id:9, name:"å¶æ©å®‡" },
{ id:10, name:"å´æ©çª" },{ id:11, name:"JOSH" },{ id:12, name:"è‹æ¥·æ‡¿" },
{ id:13, name:"KEIGO" },{ id:14, name:"è®¸æ–‡ç‘œ" },{ id:15, name:"æ—å½¥ç’" },
{ id:16, name:"æŸ³æ³“å®‡" },{ id:17, name:"æä½³è”š" },{ id:18, name:"æå‡¯ç¥¾" },
{ id:19, name:"æ—æ©ä¼" },{ id:20, name:"åˆ˜å‚‘è±ª" },{ id:21, name:"å½­çµå¸Œ" },
{ id:22, name:"ç¿åº·è»’" },{ id:23, name:"é»„éœ‡æ©" },{ id:24, name:"é»„éœ‡ç†™" },
{ id:25, name:"å‚…å­ç‘œ" },{ id:26, name:"åˆ˜ä½³å‹³" },{ id:27, name:"å“æ…§èŠ" },
{ id:28, name:"èƒ¡æ·³æ›¦" },{ id:29, name:"é»„è–‡éœ“" },{ id:30, name:"æ¥Šæ·¨è€€" },
{ id:31, name:"ZABELLE" },{ id:32, name:"ç¿Ÿå…ƒ" },{ id:33, name:"éƒ‘åœ£æ°" },
{ id:34, name:"å‘¨æ¬£æ‚¦" },{ id:35, name:"æ½˜å¸Ÿæ´" }
];

/* ===== å¸¸é‡&å­˜å‚¨ ===== */
const STORAGE_KEY = "hwTracker_multi_v8_roster_manage";
const Status = { MISSING:0, FIX:1, DONE:2 };
const StatusText = ["âŒ æœªäº¤","ğŸ“ è®¢æ­£","âœ… å®Œæˆ"];
const clsBtn = ["st-miss","st-fix","st-done"];
const clsTag = ["miss","fix","done"];

/* å·¥å…· */
function todayStr(){
  const d=new Date();
  return `${d.getFullYear()}-${String(d.getMonth()+1).padStart(2,"0")}-${String(d.getDate()).padStart(2,"0")}`;
}
function sortStudentsInPlace(arr){
  arr.sort((a,b)=>Number(a.id)-Number(b.id));
}
function freshState(){
  const students = JSON.parse(JSON.stringify(DEFAULT_STUDENTS));
  sortStudentsInPlace(students);
  return {students, assignments:[], lastSaved:null};
}

/* è¯»å†™ */
function load(){
  const raw=localStorage.getItem(STORAGE_KEY);
  if(!raw) return freshState();
  try{
    const data=JSON.parse(raw);
    if(!Array.isArray(data.students) || data.students.length===0){
      data.students = JSON.parse(JSON.stringify(DEFAULT_STUDENTS));
    }
    sortStudentsInPlace(data.students);

    // ç¡®ä¿æ¯ä¸ªä½œä¸šéƒ½æœ‰æ¯ä¸ªå­¦ç”Ÿçš„è®°å½•
    data.assignments = Array.isArray(data.assignments) ? data.assignments : [];
    data.assignments.forEach(a=>{
      if(!a.students) a.students = {};
      data.students.forEach(s=>{
        const sid=String(s.id);
        if(!(sid in a.students)) a.students[sid]={status:0,note:""};
      });
      // ç§»é™¤å·²ä¸å­˜åœ¨çš„å­¦ç”Ÿ
      Object.keys(a.students).forEach(sid=>{
        if(!data.students.some(s=>String(s.id)===sid)) delete a.students[sid];
      });
    });
    return data;
  }catch(e){
    console.warn("Parse fail:",e);
    return freshState();
  }
}

let state=load();
let currentIdx=state.assignments.length?0:-1;

function save(){
  state.lastSaved=Date.now();
  localStorage.setItem(STORAGE_KEY, JSON.stringify(state));
  updateSaveInfo();
}
function updateSaveInfo(){
  const el=document.getElementById("saveInfo");
  if(!state.lastSaved){ el.textContent="æœªä¿å­˜"; return; }
  const d=new Date(state.lastSaved);
  el.textContent=`å·²ä¿å­˜ ${String(d.getHours()).padStart(2,"0")}:${String(d.getMinutes()).padStart(2,"0")}`;
}

/* DOM */
const tabsEl=document.getElementById("assignmentTabs");
const delBtn=document.getElementById("deleteAssignmentBtn");
const newName=document.getElementById("newAssignmentName");
const newDate=document.getElementById("newAssignmentDate");
const tbodyAss=document.getElementById("tbodyAssignment");
const hintAllDone=document.getElementById("allDoneHint");
const curTitle=document.getElementById("currentAssignmentTitle");

const byAssignment=document.getElementById("byAssignment");
const byStudent=document.getElementById("byStudent");
const studentOverview=document.getElementById("studentOverview");
const issueSection=document.getElementById("issueSection");
const issueOverview=document.getElementById("issueOverview");

/* åå•ç®¡ç† DOM */
const newStuId=document.getElementById("newStuId");
const newStuName=document.getElementById("newStuName");
const addStudentBtn=document.getElementById("addStudentBtn");
const deleteStudentSelect=document.getElementById("deleteStudentSelect");
const deleteStudentBtn=document.getElementById("deleteStudentBtn");

/* æ¸²æŸ“ï¼šåˆ é™¤ä¸‹æ‹‰åå• */
function renderDeleteStudentOptions(){
  deleteStudentSelect.innerHTML="";
  state.students.forEach(s=>{
    const opt=document.createElement("option");
    opt.value=String(s.id);
    opt.textContent=`${s.id}. ${s.name}`;
    deleteStudentSelect.appendChild(opt);
  });
  deleteStudentBtn.disabled = (state.students.length===0);
}

/* æ¸²æŸ“ï¼šä½œä¸šæ ‡ç­¾ */
function renderTabs(){
  tabsEl.innerHTML="";
  state.assignments.forEach((a,idx)=>{
    const t=document.createElement("button");
    t.className="tab"+(idx===currentIdx?" active":"");
    t.textContent=a.name||("æœªå‘½åä½œä¸š"+(idx+1));
    t.title=a.date||"";
    t.onclick=()=>{ currentIdx=idx; render(); };
    tabsEl.appendChild(t);
  });
  delBtn.disabled=(currentIdx<0);
}

/* æ¸²æŸ“ï¼šæŒ‰ä½œä¸šç®¡ç† */
function renderAssignmentTable(){
  tbodyAss.innerHTML="";
  const selectAllEl=document.getElementById("selectAll");
  if(selectAllEl) selectAllEl.checked=false;

  if(currentIdx<0){
    curTitle.textContent="å½“å‰ï¼šâ€”";
    hintAllDone.textContent="";
    return;
  }
  const a=state.assignments[currentIdx];
  curTitle.textContent=`å½“å‰ï¼š${a.name||"æœªå‘½åä½œä¸š"}ï¼ˆ${a.date||"æ— æ—¥æœŸ"}ï¼‰`;

  let allDone=true;
  state.students.forEach(s=>{
    const sid=String(s.id);

    const row=document.createElement("tr");

    const tdCheck=document.createElement("td");
    const cb=document.createElement("input");
    cb.type="checkbox";
    cb.className="checkbox selectBox";
    cb.dataset.sid=sid;
    tdCheck.appendChild(cb);
    row.appendChild(tdCheck);

    const tdName=document.createElement("td");
    tdName.innerHTML=`<div class="name">${s.id}. ${s.name}</div>`;
    row.appendChild(tdName);

    const tdSt=document.createElement("td");
    const btn=document.createElement("div");
    const st=a.students[sid]?.status ?? 0;
    btn.className="stbtn "+clsBtn[st];
    btn.textContent=StatusText[st];
    btn.onclick=()=>{
      const cur=a.students[sid]?.status ?? 0;
      const nxt=(cur+1)%3;
      a.students[sid]={...a.students[sid], status:nxt};
      save(); render();
    };
    tdSt.appendChild(btn);
    row.appendChild(tdSt);

    const tdNote=document.createElement("td");
    const ip=document.createElement("input");
    ip.type="text";
    ip.className="note";
    ip.placeholder="å¤‡æ³¨ï¼ˆå¯é€‰ï¼‰";
    ip.value=a.students[sid]?.note ?? "";
    ip.oninput=()=>{ a.students[sid]={...a.students[sid], note:ip.value}; save(); };
    tdNote.appendChild(ip);
    row.appendChild(tdNote);

    tbodyAss.appendChild(row);

    if((a.students[sid]?.status ?? 0)!==2) allDone=false;
  });

  hintAllDone.textContent=allDone ? "ğŸ‰ æ­¤ä½œä¸šå…¨ç­å‡å·²å®Œæˆï¼Œå¯å®‰å…¨åˆ é™¤ã€‚" : "";

  const selectAll=document.getElementById("selectAll");
  if(selectAll){
    selectAll.onchange=()=>{ document.querySelectorAll('#tbodyAssignment .selectBox').forEach(cb=>cb.checked=selectAll.checked); };
  }
}

/* æ¸²æŸ“ï¼šæŒ‰å­¦ç”Ÿï¼ˆå…¨ç­ï¼‰ */
function renderStudentOverviewAll(){
  studentOverview.innerHTML="";
  state.students.forEach(s=>{
    const sid=String(s.id);

    const row=document.createElement("div");
    row.className="student-row";

    const nameEl=document.createElement("div");
    nameEl.className="stu-name";
    nameEl.textContent=`${s.id}. ${s.name}`;
    row.appendChild(nameEl);

    const tags=document.createElement("div");
    tags.className="tags";

    let missCnt=0, fixCnt=0, doneCnt=0;
    state.assignments.forEach(a=>{
      const st=a.students[sid]?.status ?? 0;
      if(st===0 || st===1){
        const tag=document.createElement("button");
        tag.className=`tag ${clsTag[st]}`;
        tag.textContent=`${a.name||"æœªå‘½å"}ï¼š${StatusText[st]}`;
        tag.title="ç‚¹ä¸€ä¸‹åˆ‡æ¢çŠ¶æ€";
        tag.onclick=()=>{
          const cur=a.students[sid]?.status ?? 0;
          const nxt=(cur+1)%3;
          a.students[sid]={...a.students[sid], status:nxt};
          save(); renderStudentOverviewAll(); renderIssueOverview();
        };
        tags.appendChild(tag);
      }
      if(st===0) missCnt++; else if(st===1) fixCnt++; else doneCnt++;
    });

    if(missCnt===0 && fixCnt===0){
      const allok=document.createElement("span");
      allok.className="tag done";
      allok.textContent="âœ… å…¨éƒ¨å®Œæˆ";
      tags.appendChild(allok);
    }

    row.appendChild(tags);

    const stat=document.createElement("div");
    stat.className="statline";
    stat.textContent=`ç»Ÿè®¡ï¼šæœªäº¤ ${missCnt} Â· è®¢æ­£ ${fixCnt} Â· å®Œæˆ ${doneCnt}`;
    row.appendChild(stat);

    studentOverview.appendChild(row);
  });
}

/* æ¸²æŸ“ï¼šä½œä¸šæœ‰é—®é¢˜æ€»è§ˆï¼ˆç½®é¡¶ï¼‰ */
function renderIssueOverview(){
  issueOverview.innerHTML="";
  if(!state.assignments.length){ issueSection.classList.add("hide"); return; }

  let anyIssue=false;

  state.assignments.forEach(a=>{
    const missList=[], fixList=[];
    state.students.forEach(s=>{
      const sid=String(s.id);
      const st=a.students?.[sid]?.status ?? 0;
      if(st===0) missList.push(s);
      if(st===1) fixList.push(s);
    });

    if(missList.length===0 && fixList.length===0) return;
    anyIssue=true;

    const card=document.createElement("div");
    card.className="issue-card";

    const title=document.createElement("div");
    title.className="issue-title";
    const total=state.students.length;
    const doneCount= total - missList.length - fixList.length;
    title.textContent=`${a.name||"æœªå‘½åä½œä¸š"}ï¼ˆæœªäº¤ ${missList.length} Â· è®¢æ­£ ${fixList.length} Â· å®Œæˆ ${doneCount}ï¼‰`;
    card.appendChild(title);

    const row1=document.createElement("div");
    row1.className="issue-row";
    const lb1=document.createElement("span");
    lb1.className="label"; lb1.textContent="âŒ æœªäº¤ï¼š";
    row1.appendChild(lb1);

    const chips1=document.createElement("div"); chips1.className="chips";
    missList.forEach(s=>{
      const sid=String(s.id);
      const c=document.createElement("button");
      c.className="chip miss";
      c.textContent=`${s.id}. ${s.name}`;
      c.title="ç‚¹ä¸€ä¸‹åˆ‡æ¢è¯¥ç”Ÿåœ¨æœ¬ä½œä¸šçš„çŠ¶æ€";
      c.onclick=()=>{
        const cur=a.students[sid]?.status ?? 0;
        const nxt=(cur+1)%3;
        a.students[sid]={...a.students[sid], status:nxt};
        save(); renderStudentOverviewAll(); renderIssueOverview();
      };
      chips1.appendChild(c);
    });
    if(!missList.length){
      const none=document.createElement("span");
      none.className="small"; none.textContent="ï¼ˆæ— ï¼‰";
      chips1.appendChild(none);
    }
    row1.appendChild(chips1);
    card.appendChild(row1);

    const row2=document.createElement("div");
    row2.className="issue-row";
    const lb2=document.createElement("span");
    lb2.className="label"; lb2.textContent="ğŸ“ è®¢æ­£ï¼š";
    row2.appendChild(lb2);

    const chips2=document.createElement("div"); chips2.className="chips";
    fixList.forEach(s=>{
      const sid=String(s.id);
      const c=document.createElement("button");
      c.className="chip fix";
      c.textContent=`${s.id}. ${s.name}`;
      c.title="ç‚¹ä¸€ä¸‹åˆ‡æ¢è¯¥ç”Ÿåœ¨æœ¬ä½œä¸šçš„çŠ¶æ€";
      c.onclick=()=>{
        const cur=a.students[sid]?.status ?? 0;
        const nxt=(cur+1)%3;
        a.students[sid]={...a.students[sid], status:nxt};
        save(); renderStudentOverviewAll(); renderIssueOverview();
      };
      chips2.appendChild(c);
    });
    if(!fixList.length){
      const none=document.createElement("span");
      none.className="small"; none.textContent="ï¼ˆæ— ï¼‰";
      chips2.appendChild(none);
    }
    row2.appendChild(chips2);
    card.appendChild(row2);

    issueOverview.appendChild(card);
  });

  if(!anyIssue){
    const ok=document.createElement("div");
    ok.className="issue-card";
    ok.innerHTML="<div class='issue-title'>ğŸ‰ æ‰€æœ‰ä½œä¸šå‡å·²å®Œæˆï¼Œæ— éœ€è·Ÿè¿›ã€‚</div>";
    issueOverview.appendChild(ok);
  }

  issueSection.classList.remove("hide");
}

/* æ‰¹é‡å·¥å…· */
function getSelectedSids(){
  return Array.from(document.querySelectorAll('#tbodyAssignment .selectBox:checked')).map(cb=>cb.dataset.sid);
}
function setAllStatus(status){
  if(currentIdx<0) return;
  const a=state.assignments[currentIdx];
  state.students.forEach(s=>{
    const sid=String(s.id);
    a.students[sid]={...a.students[sid], status:status};
  });
  save(); render();
}
function setSelectedStatus(status){
  if(currentIdx<0) return;
  const a=state.assignments[currentIdx];
  const sids=getSelectedSids();
  if(!sids.length){ alert("è¯·å…ˆå‹¾é€‰è¦æ›´æ–°çš„å­¦ç”Ÿã€‚"); return; }
  sids.forEach(sid=>{ a.students[sid]={...a.students[sid], status:status}; });
  save(); render();
}

/* æ€»æ¸²æŸ“ */
function render(){
  updateSaveInfo();
  sortStudentsInPlace(state.students);
  renderDeleteStudentOptions();
  renderTabs();
  renderAssignmentTable();

  const mode=document.getElementById("viewMode").value;
  if(mode==="assignment"){
    byAssignment.classList.remove("hide");
    issueSection.classList.add("hide");
    byStudent.classList.add("hide");
  }else{
    byAssignment.classList.add("hide");
    renderIssueOverview();
    renderStudentOverviewAll();
    byStudent.classList.remove("hide");
  }
}

/* ===== äº‹ä»¶ï¼šä½œä¸š ===== */
document.getElementById("addAssignmentBtn").onclick=()=>{
  const name=newName.value.trim();
  const date=newDate.value.trim()||todayStr();
  if(!name){ alert("è¯·è¾“å…¥ä½œä¸šåç§°"); return; }

  const rec={};
  state.students.forEach(s=>{ rec[String(s.id)]={status:0, note:""}; });

  const id=(typeof crypto!=="undefined" && crypto.randomUUID)? crypto.randomUUID(): String(Date.now());
  state.assignments.unshift({id, name, date, students:rec});
  currentIdx=0; newName.value=""; newDate.value="";
  save(); render();
};

document.getElementById("deleteAssignmentBtn").onclick=()=>{
  if(currentIdx<0) return;
  const a=state.assignments[currentIdx];
  const allDone=state.students.every(s=>(a.students[String(s.id)]?.status??0)===2);
  const msg= allDone ? `ç¡®è®¤åˆ é™¤ã€Œ${a.name}ã€å—ï¼Ÿï¼ˆå…¨ç­å·²å®Œæˆï¼‰` : `ã€Œ${a.name}ã€å°šæœ‰æœªå®Œæˆè®°å½•ï¼Œä»è¦åˆ é™¤å—ï¼Ÿ`;
  if(confirm(msg)){
    state.assignments.splice(currentIdx,1);
    currentIdx=state.assignments.length?0:-1;
    save(); render();
  }
};

document.getElementById("viewMode").onchange=()=>render();

/* ===== äº‹ä»¶ï¼šæ‰¹é‡ ===== */
document.getElementById("bulkAllMissing").onclick=()=>setAllStatus(0);
document.getElementById("bulkAllFix").onclick=()=>setAllStatus(1);
document.getElementById("bulkAllDone").onclick=()=>setAllStatus(2);
document.getElementById("bulkApplySelected").onclick=()=>{
  const status=Number(document.getElementById("bulkSelectStatus").value);
  setSelectedStatus(status);
};
document.getElementById("bulkClearSelection").onclick=()=>{
  const sel=document.getElementById("selectAll"); if(sel) sel.checked=false;
  document.querySelectorAll('#tbodyAssignment .selectBox').forEach(cb=>cb.checked=false);
};
document.addEventListener("change",(e)=>{
  if(e.target && e.target.id==="selectAll"){
    document.querySelectorAll('#tbodyAssignment .selectBox').forEach(cb=>cb.checked=e.target.checked);
  }
});

/* ===== âœ… äº‹ä»¶ï¼šåå•ç®¡ç†ï¼ˆæ–°å¢ï¼‰ ===== */
addStudentBtn.onclick=()=>{
  const idVal = Number(newStuId.value);
  const nameVal = (newStuName.value || "").trim();

  if(!Number.isInteger(idVal) || idVal<=0){
    alert("å­¦å·è¯·è¾“å…¥æ­£æ•´æ•°ï¼ˆä¾‹å¦‚ 36ï¼‰ã€‚");
    return;
  }
  if(!nameVal){
    alert("è¯·è¾“å…¥å­¦ç”Ÿå§“åã€‚");
    return;
  }
  if(state.students.some(s=>Number(s.id)===idVal)){
    alert(`å­¦å· ${idVal} å·²å­˜åœ¨ï¼Œè¯·æ¢ä¸€ä¸ªå­¦å·ã€‚`);
    return;
  }

  // æ·»åŠ å­¦ç”Ÿåˆ°åå•
  state.students.push({id:idVal, name:nameVal});
  sortStudentsInPlace(state.students);

  // åŒæ­¥åˆ°æ‰€æœ‰ä½œä¸š
  state.assignments.forEach(a=>{
    const sid=String(idVal);
    if(!a.students) a.students={};
    a.students[sid]={status:0, note:""};
  });

  newStuId.value="";
  newStuName.value="";
  save(); render();
};

deleteStudentBtn.onclick=()=>{
  if(state.students.length===0){ alert("å½“å‰æ²¡æœ‰å­¦ç”Ÿå¯åˆ é™¤ã€‚"); return; }
  const sid = deleteStudentSelect.value;
  const target = state.students.find(s=>String(s.id)===String(sid));
  if(!target){ alert("æ‰¾ä¸åˆ°è¯¥å­¦ç”Ÿã€‚"); return; }

  const ok = confirm(`ç¡®å®šåˆ é™¤ï¼š${target.id}. ${target.name} ï¼Ÿ\nï¼ˆä¼šä»æ‰€æœ‰ä½œä¸šè®°å½•ä¸­ç§»é™¤ï¼Œæ— æ³•æ¢å¤ï¼‰`);
  if(!ok) return;

  // ä»åå•ç§»é™¤
  state.students = state.students.filter(s=>String(s.id)!==String(sid));

  // ä»æ‰€æœ‰ä½œä¸šç§»é™¤è¯¥å­¦ç”Ÿè®°å½•
  state.assignments.forEach(a=>{
    if(a.students && (String(sid) in a.students)) delete a.students[String(sid)];
  });

  save(); render();
};

/* å¯åŠ¨ï¼šå¦‚æœæ²¡æœ‰ä½œä¸šï¼Œç»™ä¸€ä¸ªç¤ºä¾‹ä½œä¸š */
if(!state.assignments.length){
  const rec={};
  state.students.forEach(s=>{ rec[String(s.id)]={status:0, note:""}; });
  state.assignments.push({id:String(Date.now()), name:"ç¬¬8è¯¾å¬å†™ï¼ˆç¤ºä¾‹ï¼‰", date:todayStr(), students:rec});
  currentIdx=0;
  save();
}

render();
document.addEventListener("visibilitychange",()=>{ if(!document.hidden) updateSaveInfo();});
</script>
</body>
</html>
